# Mockup Generation Fix Documentation

## Overview

This document explains the fixes applied to resolve the mockup generation issues when users navigate to the design page. The main problem was that blank mockups were not being generated properly, causing 404 errors and falling back to catalog images instead of proper product mockups.

## Issues Identified

1. **Product ID Mismatch**: The productId in the URL didn't always match the actual product ID of the variant, causing 404 errors from Printful's API.
2. **Insufficient Error Handling**: Errors weren't properly logged or handled, making debugging difficult.
3. **Poor Fallback Strategy**: When mockup generation failed, the fallback images weren't appropriate.
4. **No Loading State**: Users didn't see feedback while mockups were being generated.

## Fixes Applied

### 1. Backend: Improved Blank Mockup Endpoint (`backend/routes/catalog.js`)

**Key Changes:**

- **Always fetch actual product ID from variant**: Instead of trusting the URL parameter, we now always query Printful to get the correct product ID from the variant data.
  
- **Enhanced logging**: Added comprehensive logging with clear markers:
  ```
  ========== BLANK MOCKUP REQUEST ==========
  [BLANK MOCKUP] Step 1: Fetching variant...
  [BLANK MOCKUP] Step 2: Generating blank mockup...
  [BLANK MOCKUP] Step 3: Creating task...
  [BLANK MOCKUP] Step 4: Polling for task...
  ========== END BLANK MOCKUP ==========
  ```

- **Better error handling**: Each step now has proper error handling with fallback mechanisms:
  - If variant lookup fails → use variant fallback image
  - If mockup creation fails → try outline fallback, then variant fallback
  - If polling times out → try outline fallback, then variant fallback

- **Improved response information**: The response now includes a `source` field to indicate where the mockup came from:
  - `printful` - Generated by Printful API
  - `cache` - Served from cache
  - `variant-fallback` - Using variant catalog image
  - `outline` - Using product outline template

### 2. Frontend: Better Loading States (`frontend/src/app/design/[productId]/[variantId]/page.tsx`)

**Key Changes:**

- **Added loading indicator**: Shows a spinner while the initial blank mockup is being generated
- **Enhanced logging**: Added console logs to track mockup initialization
- **Better error messaging**: Users see clear messages when mockups are unavailable

### 3. Test Script (`backend/test-mockup.js`)

Created a test script to verify mockup generation works correctly:

```bash
cd backend
node test-mockup.js <variantId>
```

## User Flow

1. **User visits Shop page** (`/shop`)
2. **Clicks on a product** → Navigates to `/product/{productId}`
3. **Selects color and size** → Variant is selected
4. **Clicks "Start Designing"** → Navigates to `/design/{productId}/{variantId}`
5. **Design page loads**:
   - Shows loading spinner
   - Backend fetches variant info from Printful
   - Backend creates blank mockup task
   - Backend polls until mockup is ready
   - Mockup URL is displayed on canvas
   - If any step fails, appropriate fallback image is shown

## API Endpoints

### POST `/api/catalog/products/:productId/blank-mockup`

Generates a blank product mockup (no design elements).

**Request Body:**
```json
{
  "variantId": 4012,
  "placement": "front"
}
```

**Response (Success):**
```json
{
  "mockup_url": "https://...",
  "source": "printful"
}
```

**Response (Fallback):**
```json
{
  "mockup_url": "https://...",
  "source": "variant-fallback"
}
```

### POST `/api/catalog/products/:productId/mockup`

Generates a mockup with custom design elements.

**Request Body:**
```json
{
  "variantId": 4012,
  "placement": "front",
  "designDataUrl": "data:image/png;base64,..."
}
```

## Troubleshooting

### Issue: Still getting 404 errors

**Check:**
1. Is the variant ID valid? Test with: `node backend/test-mockup.js <variantId>`
2. Is the Printful API key valid? Check `.env` file
3. Check backend logs for detailed error messages

### Issue: Mockups timing out

**Possible causes:**
- Printful API is slow (wait longer)
- Network issues
- Variant doesn't support mockup generation for that placement

**Solutions:**
1. Check backend logs to see which step is timing out
2. Try a different variant
3. Increase `maxAttempts` in the polling loop

### Issue: Seeing catalog images instead of mockups

**This is expected behavior when:**
- Mockup generation fails (404, timeout, etc.)
- Variant doesn't support mockup generation
- Printful API is unavailable

**To force mockup generation:**
1. Clear the mockup cache (restart backend)
2. Check that the variant supports mockup generation
3. Test with the test script to see actual error messages

### Issue: Loading spinner never disappears

**Check:**
1. Backend is running
2. No CORS errors in browser console
3. Backend logs show the request was received
4. API key is valid

## Environment Variables

Required in `backend/.env`:
```
PRINTFUL_API_KEY=your_api_key_here
PRINTFUL_STORE_ID=your_store_id_here  # Optional but recommended
DATABASE_URL=your_mongodb_connection_string
BACKEND_URL=http://localhost:5000  # Optional, for public image URLs
```

## Logging

### Backend Console Output

When a mockup request is made, you should see:

```
========== BLANK MOCKUP REQUEST ==========
Timestamp: 2025-10-14T...
Request productId: 71
Request body: { variantId: 4012, placement: 'front' }
[BLANK MOCKUP] Step 1: Fetching variant 4012 to get actual product ID...
[BLANK MOCKUP] ✓ Found actual product ID 71 from variant 4012
[BLANK MOCKUP] Step 2: Generating blank mockup for product 71, variant 4012, placement front
[BLANK MOCKUP] Step 3: Creating task at https://api.printful.com/mockup-generator/create-task/71
[BLANK MOCKUP] Printful response status: 200
[BLANK MOCKUP] ✓ Task created successfully
[BLANK MOCKUP] Step 4: Polling for task abc123...
[BLANK MOCKUP] Poll attempt 1/20: status=pending
[BLANK MOCKUP] Poll attempt 2/20: status=pending
[BLANK MOCKUP] Poll attempt 3/20: status=completed
[BLANK MOCKUP] ✓ Mockup generated successfully: https://...
[BLANK MOCKUP] ✓✓✓ SUCCESS! Mockup URL cached and returned
========== END BLANK MOCKUP (SUCCESS) ==========
```

### Browser Console Output

When navigating to the design page:

```
Fetching product with productId: 71
Product data received: {...}
Found 20 variants
Selected variant: {...}
Initializing mockup for variant 4012, placement front
Loaded blank mockup URL: https://...
```

## Performance Optimizations

1. **Caching**: Blank mockups are cached for 1 hour to reduce API calls
2. **Parallel requests**: Print area info and mockup generation happen in sequence but are optimized
3. **Smart fallbacks**: Multiple fallback layers ensure users always see something

## Common Printful API Errors

| Error Code | Meaning | Solution |
|------------|---------|----------|
| 404 | Product/variant not found | Verify variant ID is correct |
| 400 | Invalid request | Check request payload format |
| 401 | Invalid API key | Check PRINTFUL_API_KEY |
| 429 | Rate limit exceeded | Wait and retry |
| 500 | Printful server error | Use fallback images |

## Testing Checklist

- [ ] Backend server starts without errors
- [ ] Can navigate to `/shop` and see products
- [ ] Can click on a product and see variants
- [ ] Can select color and size
- [ ] "Start Designing" button is enabled
- [ ] Design page shows loading spinner
- [ ] Mockup appears (or appropriate fallback)
- [ ] Can drag artwork onto canvas
- [ ] Can add and edit text
- [ ] "See Mockup" button generates custom mockup
- [ ] Backend logs show detailed information

## Additional Resources

- [Printful API Documentation](https://developers.printful.com/)
- [Printful Mockup Generator API](https://developers.printful.com/docs/#tag/Mockup-Generator-API)
- Test script: `backend/test-mockup.js`

## Support

If you continue to experience issues:

1. Run the test script: `node backend/test-mockup.js <variantId>`
2. Check backend logs for detailed error messages
3. Verify all environment variables are set correctly
4. Test with a known-good variant (e.g., 4012 for Bella+Canvas 3001 T-shirt)
5. Check Printful API status at https://status.printful.com/

